<?php
/*
Plugin Name: WP Vulnerability Scanner
Description: Checks if any of your plugins has vulnerabilities
Plugin URI: https://angrycreative.se
Author: angrycreative, moelleer, pekz0r
Author URI: https://angrycreative.se
Version: 1.0
License: GPL2
Text Domain: wp-vulnerability-scanner
*/

define( 'NAGIOS_STATUS_OK', 'OK' );
define( 'NAGIOS_STATUS_WARNING', 'Warning' );
define( 'NAGIOS_STATUS_CRITICAL', 'Critical' );
define( 'NAGIOS_STATUS_UNKNOWN', 'Unknown' );

if( class_exists( 'WP_CLI' ) ) {

    class WP_Check_Vulnerability extends WP_CLI_Command {
        /**
         * Prints a greeting.
         *
         * ## OPTIONS
         *
         *
         * [--output=<output>]
         * : Whether or not to greet the person with success or error.
         * ---
         * default: pretty
         * options:
         *   - pretty
         *   - json
         *   - nagios
         * ---
         *
         * ## EXAMPLES
         *
         *     wp wpsv scan
         *
         * @when after_wp_load
         */
        function scan( $args, $assoc_args ) {

            $output = $assoc_args['output'];

            $base_url = 'https://wpvulndb.com/api/v2/plugins/';

            // Check if get_plugins() function exists. This is required on the front end of the
            // site, since it is in a file that is normally only loaded in the admin.
            if ( ! function_exists( 'get_plugins' ) ) {
                require_once ABSPATH . 'wp-admin/includes/plugin.php';
            }

            $all_plugins = get_plugins();

            $unsafe_plugins = array();

            foreach( $all_plugins as $path => $plugin ) {

                $plugin_version = $plugin['Version'];

                $plugin_slug = untrailingslashit( plugin_dir_path( $path ) );

                $result = (array) json_decode( wp_remote_get( $base_url . $plugin_slug )['body'] );

                echo 'Scanning ' . $plugin['Name'] . ' (v' . $plugin_version . ')' . PHP_EOL;                

                if( !empty( $result[$plugin_slug]->vulnerabilities ) ) {

                    $vulnerabilities = $result[$plugin_slug]->vulnerabilities;

                    $unsafe = false;

                    foreach( $vulnerabilities as $vul ) {
                        
                        $fixed_in = $vul->fixed_in;

                        if( empty( $fixed_in ) || version_compare( $plugin_version, $fixed_in ) === -1 ) {
                            $unsafe = true;
                            break;
                        }
                    }

                    if( $unsafe ) {
                        $unsafe_plugins[] = $plugin_slug;
                        $this->print_output( 'YOU HAVE AN UNSAFE VERSION' , $output, NAGIOS_STATUS_CRITICAL );
                        echo print_r( $result[$plugin_slug]->vulnerabilities, true );
                    } else {
                        $this->print_output( 'EXPLOIT EXISTS, BUT YOU HAVE A SAFE VERSION', $output, NAGIOS_STATUS_WARNING );
                    }

                } else {
                    $this->print_output( 'IZ OK!', $output, NAGIOS_STATUS_OK );
                }

            }
            if( !empty( $unsafe_plugins ) ) {
                $unsafe_plugins_str = implode(', ', $unsafe_plugins );
                $unsafe_plugins_num = count( $unsafe_plugins );
                WP_CLI::error( '[WP_Vulnerability_Scanner] [' . get_site_url() . ']: Found ' . sprintf( _n( '%s plugin', '%s plugins', $unsafe_plugins_num, 'wp-vulnerability-scanner' ), number_format_i18n( $unsafe_plugins_num ) ) . ' (' . $unsafe_plugins_str . ') with vulnerabilities...' );
            } else {
                WP_CLI::success( '[WP_Vulnerability_Scanner] [' . get_site_url() . ']: Congratulations, you are safe!' );
            }
        }

        public function print_output( $msg = '', $type = 'pretty', $status ) {
            if( $type = 'nagios' ) {
                echo $status . ': ' . $msg . PHP_EOL;
            } else {
                echo $msg;
            }
        }
    }

    WP_CLI::add_command( 'wpvs', 'WP_Check_Vulnerability' );
}
