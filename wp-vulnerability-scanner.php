<?php
/*
Plugin Name: WP Vulnerability Scanner
Description: Checks if any of your plugins has vurnabilities
Plugin URI: https://angrycreative.se
Author: angrycreative, moelleer, pekz0r
Author URI: https://angrycreative.se
Version: 1.0
License: GPL2
Text Domain: wp-vulnerability-scanner
*/

// 1. Command is a function
if( class_exists( 'WP_CLI' ) ) {

    function foo_command( $args ) {
        $base_url = 'https://wpvulndb.com/api/v2/plugins/';

        // Check if get_plugins() function exists. This is required on the front end of the
        // site, since it is in a file that is normally only loaded in the admin.
        if ( ! function_exists( 'get_plugins' ) ) {
            require_once ABSPATH . 'wp-admin/includes/plugin.php';
        }

        $all_plugins = get_plugins();

        $insecure = 0;

        foreach( $all_plugins as $path => $plugin ) {

            $plugin_version = $plugin['Version'];

            $plugin_slug = untrailingslashit( plugin_dir_path( $path ) );

            $result = (array) json_decode( wp_remote_get( $base_url . $plugin_slug )['body'] );

            echo 'Scanning ' . $plugin['Name'] . PHP_EOL;

            if( !empty( $result[$plugin_slug]->vulnerabilities ) ) {

                $vulnerabilities = $result[$plugin_slug]->vulnerabilities;

                $unsafe = false;

                foreach( $vulnerabilities as $vul ) {
                    
                    $fixed_in = $vul->fixed_in;

                    if( empty( $fixed_in ) || $plugin_version < $fixed_in ) {
                        $unsafe = true;
                        break;
                    }
                }

                if( $unsafe ) {
                    $insecure++;
                    echo 'YOU HAVE AN UNSAFE VERSION' . PHP_EOL;
                    echo print_r( $result[$plugin_slug]->vulnerabilities, true );
                } else {
                    echo 'EXPLOIT EXISTS, BUT YOU HAVE A SAFE VERSION' . PHP_EOL;
                }

            } else {

                echo 'IZ OK!' . PHP_EOL;

            }

        }
        if( $insecure > 0 ) {
            WP_CLI::error( 'YOU HAVE ' . $insecure . ' INSECURE PLUGINS' );
        } else {
            WP_CLI::success( 'YOU ARE SAFE' );
        }

    }

    WP_CLI::add_command( 'foo', 'foo_command' );

}
